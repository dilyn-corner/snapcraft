# SPDX-License-Identifier: GPL-2.0
# Copyright (C) 2021 Canonical Ltd
name: pc-kernel
summary: Kernel plugin test
description: A pc kernel to test the kernel plugin.

grade: stable
build-base: core20
confinement: strict
type: kernel
adopt-info: kernel

parts:
  kernel:
    plugin: kernel
    source: https://git.launchpad.net/~ubuntu-kernel/ubuntu/+source/linux/+git/focal
    source-depth: 1
    source-type: git
    source-branch: master
    stage-packages:
      - linux-firmware
      - wireless-regdb
    kernel-kdefconfig: [defconfig, test.config]
    kernel-kconfigs:
      - CONFIG_MODULE_SIG_KEY=""
      - CONFIG_SYSTEM_TRUSTED_KEYS=""
      - CONFIG_SYSTEM_REVOCATION_KEYS=""
    kernel-enable-zfs-support: true
    override-pull: |
      snapcraftctl pull

      cp -f "${SNAPCRAFT_PROJECT_DIR}/test_defconfig" "${SNAPCRAFT_PART_SRC}/kernel/configs/test.config"
    override-build: |
      snapcraftctl build

      snapcraftctl set-version $(git --git-dir=${SNAPCRAFT_PART_SRC}/.git describe --tags | cut -c 8-38)
