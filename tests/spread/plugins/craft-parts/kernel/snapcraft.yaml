# SPDX-License-Identifier: GPL-2.0
# Copyright (C) 2021 Canonical Ltd
name: pc-kernel
summary: Kernel plugin test
description: A pc kernel to test the kernel plugin.

grade: stable
build-base: core22
confinement: strict
type: kernel
adopt-info: kernel

parts:
  kernel:
    plugin: kernel
    source: https://git.launchpad.net/~ubuntu-kernel/ubuntu/+source/linux/+git/jammy
    source-depth: 1
    source-type: git
    source-branch: master
    kernel-kdefconfig: [defconfig, test.config]
    kernel-kconfigs:
      - CONFIG_MODULE_SIG_KEY=""
      - CONFIG_SYSTEM_TRUSTED_KEYS=""
      - CONFIG_SYSTEM_REVOCATION_KEYS=""
      - CONFIG_SECURITY_SELINUX_DISABLE=n
    stage-packages:
      - linux-firmware
      - wireless-regdb
    override-pull: |
      craftctl default

      cp -f "${CRAFT_PROJECT_DIR}/test_defconfig" "${CRAFT_PART_SRC}/kernel/configs/test.config"
    override-build: |
      craftctl default

      kver="$(basename "${CRAFT_PART_INSTALL}/lib/modules/"*)"

      # Set the version of the snap to match the kernel version.
      craftctl set version="$kver"
